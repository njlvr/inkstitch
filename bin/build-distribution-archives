#!/bin/bash
VERSION="$(echo ${GITHUB_REF} | sed -e 's|refs/heads/||' -e 's|refs/tags/||' -e 's|/|-|g')"
OS="${BUILD:-$(uname)}"
ARCH="$(uname -m)"
mkdir artifacts
if [ "$BUILD" = "osx" ]; then
    cp -a images/examples palettes symbols fonts inx LICENSE VERSION dist/inkstitch.app/Contents
    cp -a icons locales print dist/inkstitch.app/Contents/MacOS
    rm -rf dist/inkstitch/
    temp_path="/tmp/inkstitch/"
    mkdir mac/
    # inside the scripts folder are:
    # - preinstaller (checks for previously installed inkstitch and deletes it) and
    # - postinstaller (moves inkstitch folder from /tmp to user Inkscape extensions folder in $HOME)
    # The postinstaller is a workaround for a proper way to install in user $HOME space

    # Build on GitHub will be handled differently from local builds
    # local builds will not be signed. They are run to produce releases for lecacy versions of macOS
    if [[ -z ${GITHUB_REF} ]]
    then
        cp -a electron/build/mac dist/inkstitch.app/Contents/electron
        pkgbuild --root dist/inkstitch.app \
                --component-plist installer_scripts/inkstitch.plist \
                --ownership recommended \
                --identifier org.inkstitch.installer \
                --version ${VERSION} \
                --scripts installer_scripts/scripts \
                --install-location ${temp_path}inkstitch.app \
                artifacts/inkstitch-${VERSION}.pkg
    else
        # This code signs and notarize the inkstitch.app
        ditto electron/build/mac dist/inkstitch.app/Contents/electron
        DEV_IDENT="Developer ID Application: Lex Neva (929A568N58)"
        echo "Signing of inkstitch.app"
        /usr/bin/codesign -s "${DEV_IDENT}" \
                        --entitlements installer_scripts/entitlements.plist \
                        --options runtime \
                        --timestamp \
                        dist/inkstitch.app -v
        echo "App Signing Verification"
        codesign -dv --verbose=4  dist/inkstitch.app
        echo "Running pkgbuild"
        INSTALLER_IDENT="Developer ID Installer: Lex Neva (929A568N58)"
        /usr/bin/pkgbuild --root dist/inkstitch.app \
                        -s "${INSTALLER_IDENT}" \
                        --component-plist installer_scripts/inkstitch.plist \
                        --ownership recommended \
                        --identifier org.inkstitch.installer \
                        --version ${VERSION} \
                        --scripts installer_scripts/scripts \
                        --install-location ${temp_path}inkstitch.app \
                        artifacts/inkstitch-${VERSION}.pkg -v
        echo "Checking installer signing"
        codesign -dv --verbose=4 artifacts/inkstitch-${VERSION}.pkg
        echo "Notary starting"
        bash bin/notarize-app '$NOTARY_ACCOUNT' \
                              '@keychain:Developer-altool' \
                              'org.inkstitch.app' \
                              artifacts/inkstitch-${VERSION}.pkg
    fi
else
    cp -a images/examples palettes symbols fonts inx LICENSE VERSION dist/inkstitch
    cp -a icons locales print dist/inkstitch/bin
    cp -a electron/build/*-unpacked dist/inkstitch/electron

fi

if [ "$BUILD" = "windows" ]; then
    mkdir win
    cp installer_scripts/template.iss win/win_build.iss
    # adds the year and version for the inno installer
    info_year=$( date "+%Y" )
    copyright_year="#define COPYRIGHT \""${info_year}"\" + URL"
	version_block="#define VERSION \""${VERSION}"\""
	sed -i'' -e '/;inkstitch-year/ a\'$'\n'"${copyright_year}"'' win/win_build.iss
	sed -i'' -e '/;inkstitch-version/ a\'$'\n'"${version_block}"'' win/win_build.iss

    iscc win/win_build.iss
	mv  win/inkstitch.exe artifacts/inkstitch-${VERSION}.exe
fi

if [ "$BUILD" = "linux" ]; then
    cd dist
    python -m zipfile -c ../artifacts/inkstitch-${VERSION}-${OS}.zip *;
    cd ..
fi
